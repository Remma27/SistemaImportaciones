@model HistorialResponseViewModel
@{
    ViewData["Title"] = "Historial del Sistema";
}

<link rel="stylesheet" href="~/css/historial.css" asp-append-version="true" />

<div class="container-fluid historial-container">
    <!-- Título y breadcrumbs -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">Inicio</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Historial del Sistema</li>
                </ol>
            </nav>
            <h2 class="mb-4">
                <i class="fas fa-history me-2"></i> Historial Completo del Sistema
            </h2>
        </div>
    </div>

    <!-- Filtros -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="filter-container">
                <h5 class="filter-title">
                    <i class="fas fa-filter me-2"></i>Filtros Rápidos
                </h5>
                <div class="row">
                    <div class="col-md-4 col-lg-3 mb-3">
                        <label for="filtroTabla" class="form-label">Tabla</label>
                        <select id="filtroTabla" class="form-select">
                            <option value="">Todas las tablas</option>
                            @{
                                var tablasUnicas = Model.Registros
                                    .Select(r => r.Tabla)
                                    .Distinct()
                                    .OrderBy(t => t);
                                    
                                foreach (var tabla in tablasUnicas)
                                {
                                    <option value="@tabla">@tabla</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="col-md-4 col-lg-3 mb-3">
                        <label for="filtroOperacion" class="form-label">Operación</label>
                        <select id="filtroOperacion" class="form-select">
                            <option value="">Todas las operaciones</option>
                            <option value="CREAR">Creación</option>
                            <option value="ANTES_EDITAR">Antes de Editar</option>
                            <option value="DESPUES_EDITAR">Después de Editar</option>
                            <option value="ELIMINAR">Eliminación</option>
                            <option value="LOGIN">Inicio de Sesión</option>
                            <option value="LOGOUT">Cierre de Sesión</option>
                        </select>
                    </div>
                    <div class="col-md-4 col-lg-3 mb-3">
                        <label for="filtroUsuario" class="form-label">Usuario</label>
                        <select id="filtroUsuario" class="form-select">
                            <option value="">Todos los usuarios</option>
                            @{
                                var usuariosUnicos = Model.Registros
                                    .Select(r => new { r.UsuarioId, r.NombreUsuario })
                                    .GroupBy(u => u.UsuarioId)
                                    .Select(g => g.First())
                                    .OrderBy(u => u.NombreUsuario);
                                    
                                foreach (var usuario in usuariosUnicos)
                                {
                                    <option value="@usuario.UsuarioId">@usuario.NombreUsuario</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="col-md-12 col-lg-3 mb-3 mt-auto">
                        <button id="limpiarFiltros" class="btn btn-outline-secondary w-100">
                            <i class="fas fa-eraser me-2"></i>Limpiar Filtros
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de Historial -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center flex-wrap">
                        <h5 class="mb-0">
                            <i class="fas fa-table me-2"></i> Registros del Historial
                        </h5>
                        <div>
                            <small class="text-light d-none d-md-block">
                                <i class="fas fa-info-circle me-1"></i> Haz clic en una fila para ver detalles
                            </small>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0 p-md-3">
                    <div class="alert alert-info d-md-none mb-2">
                        <small><i class="fas fa-info-circle me-1"></i> Haz clic en una fila para ver detalles</small>
                    </div>
                    <div class="table-responsive">
                        <table id="tablaHistorial" class="table table-striped table-hover historial-table w-100">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Usuario</th>
                                    <th>Tabla</th>
                                    <th>Operación</th>
                                    <th>Fecha y Hora</th>
                                    <th>Descripción</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model?.Registros != null && Model.Registros.Any())
                                {
                                    foreach (var registro in Model.Registros)
                                    {
                                        string badgeClass = "";
                                        string operacionIcon = "";
                                        string operacionText = registro.TipoOperacion;
                                        
                                        switch (registro.TipoOperacion.ToUpper())
                                        {
                                            case "CREAR":
                                                badgeClass = "operacion-crear";
                                                operacionIcon = "fas fa-plus-circle";
                                                operacionText = "Creación";
                                                break;
                                            case "ANTES_EDITAR":
                                                badgeClass = "operacion-antes-editar";
                                                operacionIcon = "fas fa-edit";
                                                operacionText = "Antes Editar";
                                                break;
                                            case "DESPUES_EDITAR":
                                                badgeClass = "operacion-despues-editar";
                                                operacionIcon = "fas fa-check-circle";
                                                operacionText = "Después Editar";
                                                break;
                                            case "ELIMINAR":
                                                badgeClass = "operacion-eliminar";
                                                operacionIcon = "fas fa-trash-alt";
                                                operacionText = "Eliminación";
                                                break;
                                            case "LOGIN":
                                                badgeClass = "operacion-login";
                                                operacionIcon = "fas fa-sign-in-alt";
                                                operacionText = "Inicio Sesión";
                                                break;
                                            case "LOGOUT":
                                                badgeClass = "operacion-logout";
                                                operacionIcon = "fas fa-sign-out-alt";
                                                operacionText = "Cierre Sesión";
                                                break;
                                            default:
                                                badgeClass = "operacion-otro";
                                                operacionIcon = "fas fa-info-circle";
                                                break;
                                        }
                                        
                                        <tr data-tabla="@registro.Tabla" 
                                            data-operacion="@registro.TipoOperacion" 
                                            data-usuario="@registro.UsuarioId"
                                            data-id="@registro.Id"
                                            class="registro-fila">
                                            <td data-label="ID" class="align-middle">@registro.Id</td>
                                            <td data-label="Usuario" class="align-middle">
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-user-circle me-2 text-secondary"></i>
                                                    <span>@(registro.UsuarioId == 1 ? "Sistema" : registro.NombreUsuario)</span>
                                                </div>
                                            </td>
                                            <td data-label="Tabla" class="align-middle">
                                                <div class="table-badge-container">
                                                    <span class="table-name">@registro.Tabla</span>
                                                </div>
                                            </td>
                                            <td data-label="Operación" class="align-middle">
                                                <div class="operacion-tag @badgeClass">
                                                    <i class="@operacionIcon" aria-hidden="true"></i>
                                                    <span class="operacion-text">@operacionText</span>
                                                </div>
                                            </td>
                                            <td data-label="Fecha y Hora" class="align-middle">
                                                <div class="fecha-container">
                                                    <div>
                                                        <i class="far fa-calendar-alt me-1 text-secondary"></i>
                                                        @registro.FechaHora.ToString("dd/MM/yyyy")
                                                    </div>
                                                    <div>
                                                        <i class="far fa-clock me-1 text-secondary"></i>
                                                        @registro.FechaHora.ToString("HH:mm:ss")
                                                    </div>
                                                </div>
                                            </td>
                                            <td data-label="Descripción" class="align-middle descripcion-cell">@registro.Descripcion</td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="6" class="text-center">
                                            <div class="alert alert-info mb-0">
                                                <i class="fas fa-info-circle me-2"></i>
                                                No hay registros de historial disponibles
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Limpiar almacenamiento de DataTables para evitar problemas con filtros anteriores
            localStorage.removeItem('DataTables_tablaHistorial_/HistorialView/Index');
            sessionStorage.removeItem('DataTables_tablaHistorial_/HistorialView/Index');
            
            // Verificar datos antes de inicializar
            
            // Inicializar DataTable con opciones corregidas
            var table = $('#tablaHistorial').DataTable({
                "destroy": true, // Destruir cualquier instancia previa
                "retrieve": false, // No recuperar una tabla existente
                "paging": true,
                "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Todos"]],
                "pageLength": 100, // Mostrar 100 registros por página
                "searching": true,
                "ordering": true,
                "info": true,
                "autoWidth": false,
                "responsive": {
                    details: {
                        type: 'column',
                        target: 'tr'
                    }
                },
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/Spanish.json"
                },
                "order": [[0, "desc"]], // Ordenar por ID descendente por defecto
                "dom": '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>rt<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
                "stateSave": false, // No guardar estado para evitar filtros previos
                "initComplete": function() {
                    console.log("DataTables inicializado. Registros visibles:", this.api().rows({page:'current'}).count());
                    console.log("DataTables total:", this.api().rows().count());
                }
            });
            
            // Eliminar cualquier filtro que pueda haberse aplicado
            table.search('').columns().search('').draw();
            
            // Mejorar la experiencia al hacer clic en una fila
            $('#tablaHistorial tbody').on('click', 'tr', function() {
                var id = $(this).data('id');
                if (id) {
                    window.location.href = '@Url.Action("Detalle", "HistorialView")/' + id;
                }
            });
            
            // CSS para indicar que las filas son clickeables
            $('#tablaHistorial tbody tr').css('cursor', 'pointer');
            
            // Filtros dinámicos con limpieza adecuada
            $('#filtroTabla, #filtroOperacion, #filtroUsuario').on('change', function() {
                applyFilters();
            });
            
            $('#limpiarFiltros').on('click', function() {
                // Limpiar todos los filtros
                $('#filtroTabla, #filtroOperacion, #filtroUsuario').val('');
                $.fn.dataTable.ext.search.pop();
                table.search('').columns().search('').draw();
            });
            
            function applyFilters() {
                var tabla = $('#filtroTabla').val();
                var operacion = $('#filtroOperacion').val();
                var usuario = $('#filtroUsuario').val();
                
                // Limpiar cualquier filtro previo
                $.fn.dataTable.ext.search.pop();
                
                if (tabla || operacion || usuario) {
                    // Método de filtrado sin excluir ningún ID
                    $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
                        var row = $(table.row(dataIndex).node());
                        
                        var matchTabla = !tabla || row.data('tabla') === tabla;
                        var matchOperacion = !operacion || row.data('operacion') === operacion;
                        var matchUsuario = !usuario || row.data('usuario').toString() === usuario;
                        
                        return matchTabla && matchOperacion && matchUsuario;
                    });
                }
                
                table.draw();
                console.log("Después de filtrar, registros visibles:", table.rows({search:'applied'}).count());
            }
            
            // Mejorar la visualización de DataTables
            $('.dataTables_wrapper .dataTables_length select').addClass('form-select form-select-sm');
            $('.dataTables_wrapper .dataTables_filter input').addClass('form-control form-control-sm');
            
            // Mejorar la visualización en dispositivos móviles
            function checkResponsiveDisplay() {
                if (window.innerWidth < 768) {
                    $('.dataTables_filter input').attr('placeholder', 'Buscar...');
                    
                    // Ajustar la descripción para dispositivos móviles
                    $('.descripcion-cell').each(function() {
                        var text = $(this).text();
                        if (text.length > 50) {
                            $(this).text(text.substring(0, 50) + '...');
                        }
                    });
                }
            }
            
            // Ejecutar al cargar y cuando se redimensiona la ventana
            checkResponsiveDisplay();
            $(window).resize(function() {
                checkResponsiveDisplay();
            });
        });
    </script>
}

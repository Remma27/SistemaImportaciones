@model Sistema_de_Gestion_de_Importaciones.ViewModels.RegistroPesajesViewModel

@section Styles {
    <link rel="stylesheet" href="~/css/registroPesajes.css" />
}

@{
    var isBarcoSelected = !String.IsNullOrEmpty(Context.Request.Query["selectedBarco"].ToString());
    var isEmpresaSelected = !String.IsNullOrEmpty(Context.Request.Query["empresaId"].ToString());
    var isFormValid = isBarcoSelected && isEmpresaSelected;
}

<div class="container-fluid px-4">
    <div class="table-responsive-custom">
        <!-- Header Card -->
        <div class="card mb-4 shadow">
            <div class="card-header bg-gradient bg-primary text-white py-3">
                <h4 class="mb-0"><i class="fas fa-ship me-2"></i>Registro de Pesajes</h4>
            </div>
            <div class="card-body bg-light">
                <div class="row gy-3">
                    <div class="col-lg-8">
                        <form method="get" class="needs-validation" novalidate>
                            <div class="row gy-3">
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <select name="selectedBarco" 
                                                class="form-select" 
                                                asp-items="ViewBag.Barcos" 
                                                onchange="this.form.submit()" 
                                                required>
                                            <option value="">Seleccione una Importación</option>
                                        </select>
                                        <label><i class="fas fa-ship me-2"></i>Importación</label>
                                        <div class="invalid-feedback">
                                            Por favor seleccione una importación
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <select name="empresaId" 
                                                class="form-select" 
                                                asp-items="ViewBag.Empresas" 
                                                onchange="this.form.submit()" 
                                                disabled="@(!isBarcoSelected)" 
                                                required>
                                            <option value="">Seleccione una Empresa</option>
                                        </select>
                                        <label><i class="fas fa-building me-2"></i>Empresa</label>
                                        <div class="invalid-feedback">
                                            Por favor seleccione una empresa
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="col-lg-4 d-flex align-items-center justify-content-lg-end mt-3 mt-lg-0">
                        <div class="action-buttons">
                            <button id="btnAgregar" 
                                   class="btn btn-primary action-btn" 
                                   disabled="@(!isFormValid)">
                                <i class="fas fa-plus-circle"></i>
                                <span>Agregar</span>
                            </button>

                            <button id="btnToggleEscotillas" class="btn btn-secondary action-btn" title="Mostrar/ocultar escotillas">
                                <i class="fas fa-eye-slash"></i>
                            </button>
                            
                            <a href="@(isBarcoSelected 
                                     ? Url.Action("ReporteGeneral", "RegistroPesajes", new { selectedBarco = Context.Request.Query["selectedBarco"] })
                                     : "#")" 
                               id="btnReporteEscotillas" 
                               class="btn btn-teal action-btn @(!isBarcoSelected ? "disabled" : "")" 
                               title="Reporte Escotillas por Empresa">
                                <i class="fas fa-chart-column"></i>
                            </a>
                            
                            @{
                                var hasTableData = Model.Tabla2Data != null && Model.Tabla2Data.Any();
                                var enableDetailButton = isBarcoSelected && hasTableData;
                            }

                            <a href="@(isBarcoSelected 
                                     ? Url.Action("ReporteIndividual", "RegistroPesajes", new { selectedBarco = Context.Request.Query["selectedBarco"]})
                                     : "#")" 
                               id="btnTablaDetallada" 
                               class="btn btn-dark action-btn @(!enableDetailButton ? "disabled" : "")" 
                               title="Vista detallada">
                                <i class="fas fa-table-cells"></i>
                            </a>

                            <button id="btnToggleUnidad" class="btn btn-warning action-btn" title="Mostrar en Libras">
                                <i class="fas fa-weight-scale"></i>
                                <span>Unidades</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tables Container -->
    <div class="row g-4">
        <!-- Resumen Agregado -->
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-gradient bg-purple py-3 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-white"><i class="fas fa-chart-bar me-2"></i>Resumen Agregado</h5>
                    <button id="btnExportarExcel" class="btn btn-success btn-sm" title="Exportar a Excel" disabled>
                        <i class="fas fa-file-excel me-1"></i>Exportar
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="table-scroll">
                        <table id="tabla2" class="table table-hover align-middle table-fixed-header">
                            <thead>
                                <tr>
                                    <th class="bg-white text-black">Empresa</th>
                                    <th class="bg-white text-black text-end column-md">Req. (Kg)</th>
                                    <th class="bg-white text-black text-end column-sm">Req. (Ton)</th>
                                    <th class="bg-white text-black text-end column-md">Desc. (Kg)</th>
                                    
                                    <th class="text-end column-md unit-toggle-columns">
                                        <div>Desc.</div>
                                        <div><small>Lbs / Qq</small></div>
                                    </th>
                                    
                                    <th class="bg-white text-black text-end column-md">Falt. (Kg)</th>
                                    <th class="bg-white text-black text-end column-sm">Falt. (Ton)</th>
                                    
                                    <th class="text-end column-md unit-toggle-columns">
                                        <div>Falt.</div>
                                        <div><small>Lbs / Qq</small></div>
                                    </th>
                                    
                                    <th class="bg-white text-black text-end column-sm">Cam. Falt.</th>
                                    <th class="bg-white text-black text-center column-sm">Placas</th>
                                    <th class="bg-white text-black text-end column-sm">% Desc.</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.Tabla2Data == null || !Model.Tabla2Data.Any())
                                {
                                    <tr>
                                        <td colspan="10" class="text-center">
                                            <div class="alert alert-info mb-0">
                                                <i class="fas fa-info-circle"></i>
                                                <span>No hay registros disponibles</span>
                                            </div>
                                        </td>
                                    </tr>
                                }
                                else
                                {
                                    @foreach (var item in Model.Tabla2Data)
                                    {
                                        <tr>
                                            <td>@item.Agroindustria</td>
                                            <td class="text-end">@item.KilosRequeridos.ToString("N0")</td>
                                            <td class="text-end">@item.ToneladasRequeridas.ToString("N2")</td>
                                            <td class="text-end">@item.DescargaKilos.ToString("N0")</td>

                                            <td class="text-end unit-toggle-columns conversion-cell dual-value-cell">
                                                <span class="top-value">@((item.DescargaKilos * 2.20462M).ToString("N0")) lbs</span>
                                                <span class="divider"></span>
                                                <span class="bottom-value">@((item.DescargaKilos / 45.359237M).ToString("N2")) qq</span>
                                            </td>

                                            <td class="text-end">@item.FaltanteKilos.ToString("N0")</td>
                                            <td class="text-end">@item.ToneladasFaltantes.ToString("N2")</td>

                                            <td class="text-end unit-toggle-columns conversion-cell dual-value-cell">
                                                <span class="top-value">@((item.FaltanteKilos * 2.20462M).ToString("N0")) lbs</span>
                                                <span class="divider"></span>
                                                <span class="bottom-value">@((item.FaltanteKilos / 45.359237M).ToString("N2")) qq</span>
                                            </td>

                                            <td class="text-end">@item.CamionesFaltantes.ToString("N2")</td>
                                            <td class="text-center">@item.ConteoPlacas</td>
                                            <td class="text-end">@item.PorcentajeDescarga.ToString("N2")%</td>
                                        </tr>
                                    }
                                }
                            </tbody>
                            @if (Model.Tabla2Data != null && Model.Tabla2Data.Any())
                            {
                                <tfoot>
                                    <tr class="table-purple">
                                        <td>Totales</td>
                                        <td class="text-end">@Model.Tabla2Data.Sum(x => x.KilosRequeridos).ToString("N0")</td>
                                        <td class="text-end">@Model.Tabla2Data.Sum(x => x.ToneladasRequeridas).ToString("N2")</td>
                                        <td class="text-end">@Model.Tabla2Data.Sum(x => x.DescargaKilos).ToString("N0")</td>

                                        <td class="text-end unit-toggle-columns conversion-cell dual-value-cell">
                                            <span class="top-value">@((Model.Tabla2Data.Sum(x => x.DescargaKilos) * 2.20462M).ToString("N0")) lbs</span>
                                            <span class="divider"></span>
                                            <span class="bottom-value">@((Model.Tabla2Data.Sum(x => x.DescargaKilos) / 45.359237M).ToString("N2")) qq</span>
                                        </td>

                                        <td class="text-end">@Model.Tabla2Data.Sum(x => x.FaltanteKilos).ToString("N0")</td>
                                        <td class="text-end">@Model.Tabla2Data.Sum(x => x.ToneladasFaltantes).ToString("N2")</td>

                                        <td class="text-end unit-toggle-columns conversion-cell dual-value-cell">
                                            <span class="top-value">@((Model.Tabla2Data.Sum(x => x.FaltanteKilos) * 2.20462M).ToString("N0")) lbs</span>
                                            <span class="divider"></span>
                                            <span class="bottom-value">@((Model.Tabla2Data.Sum(x => x.FaltanteKilos) / 45.359237M).ToString("N2")) qq</span>
                                        </td>

                                        <td class="text-end">@Model.Tabla2Data.Sum(x => x.CamionesFaltantes).ToString("N2")</td>
                                        <td class="text-center">@Model.Tabla2Data.Sum(x => x.ConteoPlacas)</td>
                                        <td class="text-end">
                                            @{
                                                var kilosRequeridos = Model.Tabla2Data.Sum(x => x.KilosRequeridos);
                                                var porcentaje = kilosRequeridos > 0 
                                                    ? (Model.Tabla2Data.Sum(x => x.DescargaKilos) * 100.0M / kilosRequeridos) 
                                                    : 0;
                                            }
                                            @porcentaje.ToString("N2")%
                                        </td>
                                    </tr>
                                </tfoot>
                            }
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resumen General y Escotillas -->
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-gradient bg-success py-3">
                    <h5 class="mb-0 text-white"><i class="fas fa-calculator me-2"></i>Resumen General y Escotillas</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-scroll">
                        <table class="table table-hover align-middle table-fixed-header">
                            <thead>
                                <tr class="table-success-dark">
                                    <th>Escotilla</th>
                                    <th class="text-end">Capacidad (Kg)</th>
                                    <th class="text-end">Descarga (Kg)</th>
                                    
                                    <th class="text-end unit-toggle-columns">
                                        <div>Desc.</div>
                                        <div><small>Lbs / Qq</small></div>
                                    </th>
                                    
                                    <th class="text-end">Diferencia (Kg)</th>
                                    
                                    <th class="text-end unit-toggle-columns">
                                        <div>Dif.</div>
                                        <div><small>Lbs / Qq</small></div>
                                    </th>
                                    
                                    <th class="text-end">% Descarga</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.EscotillasData == null || !Model.EscotillasData.Any())
                                {
                                    <tr>
                                        <td colspan="8" class="text-center">
                                            <div class="alert alert-info mb-0">
                                                <i class="fas fa-info-circle"></i>
                                                <span>No hay registros disponibles</span>
                                            </div>
                                        </td>
                                    </tr>
                                }
                                else
                                {
                                    @foreach (var escotilla in Model.EscotillasData)
                                    {
                                        <tr>
                                            <td>Escotilla @escotilla.NumeroEscotilla</td>
                                            <td class="text-end">@escotilla.CapacidadKg.ToString("N0")</td>
                                            <td class="text-end">@escotilla.DescargaRealKg.ToString("N0")</td>
                                            
                                            <td class="text-end unit-toggle-columns conversion-cell dual-value-cell">
                                                <span class="top-value">@((escotilla.DescargaRealKg * 2.20462M).ToString("N0")) lbs</span>
                                                <span class="divider"></span>
                                                <span class="bottom-value">@((escotilla.DescargaRealKg / 45.359237M).ToString("N2")) qq</span>
                                            </td>
                                            
                                            <td class="text-end">@escotilla.DiferenciaKg.ToString("N0")</td>
                                            
                                            <td class="text-end unit-toggle-columns conversion-cell dual-value-cell">
                                                <span class="top-value">@((escotilla.DiferenciaKg * 2.20462M).ToString("N0")) lbs</span>
                                                <span class="divider"></span>
                                                <span class="bottom-value">@((escotilla.DiferenciaKg / 45.359237M).ToString("N2")) qq</span>
                                            </td>
                                            
                                            <td class="text-end">@escotilla.Porcentaje.ToString("N2")%</td>
                                            <td>@escotilla.Estado</td>
                                        </tr>
                                    }
                                }
                            </tbody>
                            @if (Model.EscotillasData != null && Model.EscotillasData.Any())
                            {
                                <tfoot>
                                    <tr class="table-success-dark">
                                        <td>Totales</td>
                                        <td class="text-end">@Model.CapacidadTotal.ToString("N0")</td>
                                        <td class="text-end">@Model.DescargaTotal.ToString("N0")</td>
                                        
                                        <td class="text-end unit-toggle-columns conversion-cell dual-value-cell">
                                            <span class="top-value">@((Model.DescargaTotal * 2.20462M).ToString("N0")) lbs</span>
                                            <span class="divider"></span>
                                            <span class="bottom-value">@((Model.DescargaTotal / 45.359237M).ToString("N2")) qq</span>
                                        </td>
                                        
                                        <td class="text-end">@Model.DiferenciaTotal.ToString("N0")</td>
                                        
                                        <td class="text-end unit-toggle-columns conversion-cell dual-value-cell">
                                            <span class="top-value">@((Model.DiferenciaTotal * 2.20462M).ToString("N0")) lbs</span>
                                            <span class="divider"></span>
                                            <span class="bottom-value">@((Model.DiferenciaTotal / 45.359237M).ToString("N2")) qq</span>
                                        </td>
                                        
                                        <td class="text-end">@(Model.DiferenciaTotal < 0 ? "-" : "")@Math.Abs(Model.PorcentajeTotal).ToString("N2")%</td>
                                        <td>@Model.EstadoGeneral</td>
                                    </tr>
                                    <tr>
                                        <td colspan="8" class="p-3 bg-light text-center">
                                            <small class="text-muted">
                                                <i class="fas fa-info-circle me-2"></i>
                                                <strong>Nota:</strong> Diferencia con números positivos indica lo que falta, en negativo indica sobrante
                                            </small>
                                        </td>
                                    </tr>
                                </tfoot>
                            }
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla 1: Registros Individuales -->
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-gradient bg-info py-3 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-white"><i class="fas fa-table me-2"></i>Registros Individuales</h5>
                    <button id="btnExportarExcelIndividuales" class="btn btn-success btn-sm" title="Exportar a Excel" disabled>
                        <i class="fas fa-file-excel me-1"></i>Exportar
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="table-scroll">
                        <table id="tabla1" class="table table-hover align-middle mb-0 table-fixed-header">
                            <thead>
                                <tr class="table-info-dark">
                                    <th>Bodega</th>
                                    <th>Guía</th>
                                    <th>Guía Alterna</th>
                                    <th>Placa</th>
                                    <th>Placa Alterna</th>
                                    <th>Peso Requerido</th>
                                    <th>Peso Entregado</th>
                                    
                                    <th class="text-end unit-toggle-columns">
                                        <div>Entreg.</div>
                                        <div><small>Lbs / Qq</small></div>
                                    </th>
                                    
                                    <th>Peso Faltante</th>
                                    <th>Porcentaje</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody class="table-group-divider">
                                @if (Model.Tabla1Data == null || !Model.Tabla1Data.Any())
                                {
                                    <tr>
                                        <td colspan="11" class="text-center">
                                            <div class="alert alert-info mb-0">
                                                <i class="fas fa-info-circle"></i>
                                                <span>No hay registros disponibles</span>
                                            </div>
                                        </td>
                                    </tr>
                                }
                                else
                                {
                                    @foreach (var item in Model.Tabla1Data)
                                    {
                                        <tr>
                                            <td>@item.Bodega</td>
                                            <td>@(string.IsNullOrEmpty(item.Guia) ? "-" : item.Guia)</td>
                                            <td>@(string.IsNullOrEmpty(item.GuiaAlterna) ? "-" : item.GuiaAlterna)</td>
                                            <td>@(string.IsNullOrEmpty(item.Placa) ? "-" : item.Placa)</td>
                                            <td>@(string.IsNullOrEmpty(item.PlacaAlterna) ? "-" : item.PlacaAlterna)</td>
                                            <td class="text-end">@item.PesoRequerido.ToString("N0")</td>
                                            <td class="text-end">@item.PesoEntregado.ToString("N0")</td>
                                            
                                            <td class="text-end unit-toggle-columns conversion-cell dual-value-cell">
                                                <span class="top-value">@((item.PesoEntregado * 2.20462M).ToString("N0")) lbs</span>
                                                <span class="divider"></span>
                                                <span class="bottom-value">@((item.PesoEntregado / 45.359237M).ToString("N2")) qq</span>
                                            </td>
                                            
                                            <td class="text-end">@item.PesoFaltante.ToString("N0")</td>
                                            <td class="text-end">@item.Porcentaje.ToString("N2")%</td>
                                            <td>
                                                <div class="btn-group" role="group">
                                                    <a asp-controller="RegistroPesajes" 
                                                    asp-action="Edit" 
                                                    asp-route-id="@item.Id"
                                                    asp-route-selectedBarco="@Context.Request.Query["selectedBarco"]"
                                                    asp-route-empresaId="@Context.Request.Query["empresaId"]"
                                                    class="btn btn-warning btn-sm">
                                                        <i class="fas fa-edit"></i>
                                                    </a>
                                                    <a asp-controller="RegistroPesajes" 
                                                    asp-action="Delete" 
                                                    asp-route-id="@item.Id"
                                                    asp-route-selectedBarco="@Context.Request.Query["selectedBarco"]"
                                                    asp-route-empresaId="@Context.Request.Query["empresaId"]"
                                                    class="btn btn-danger btn-sm">
                                                        <i class="fas fa-trash"></i>
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                            @if (Model.Tabla1Data != null && Model.Tabla1Data.Any())
                            {
                                <tfoot class="table-group-divider">
                                    <tr class="table-info-dark">
                                        <td>Totales</td>
                                        <td colspan="3"></td>
                                        <td class="text-end">Cant. registros: @Model.Tabla1Data.Count()</td>
                                        <td class="text-end">@(Model.Tabla1Data.LastOrDefault()?.PesoRequerido.ToString("N0") ?? "0")</td>
                                        <td class="text-end">@Model.Tabla1Data.Sum(x => x.PesoEntregado).ToString("N0")</td>
                                        
                                        <td class="text-end unit-toggle-columns conversion-cell dual-value-cell">
                                            <span class="top-value">@((Model.Tabla1Data.Sum(x => x.PesoEntregado) * 2.20462M).ToString("N0")) lbs</span>
                                            <span class="divider"></span>
                                            <span class="bottom-value">@((Model.Tabla1Data.Sum(x => x.PesoEntregado) / 45.359237M).ToString("N2")) qq</span>
                                        </td>
                                        
                                        <td class="text-end">@(Model.Tabla1Data.LastOrDefault()?.PesoFaltante.ToString("N0") ?? "0")</td>
                                        <td class="text-end">@(Model.Tabla1Data.LastOrDefault()?.Porcentaje.ToString("N2") ?? "0")%</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            }
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla 3: Totales por Bodega -->
        @{
            var empresaSeleccionadaId = Context.Request.Query["empresaId"].ToString();
            var empresasList = (IEnumerable<SelectListItem>)ViewBag.Empresas;
            var selectedEmpresa = empresasList?.FirstOrDefault(e => e.Value == empresaSeleccionadaId);
            var empresaSeleccionadaNombre = selectedEmpresa?.Text;
            
            
            var mostrarTablaBodegas = !string.IsNullOrEmpty(empresaSeleccionadaNombre) && 
                                   empresaSeleccionadaNombre.IndexOf("INTERGLO", StringComparison.OrdinalIgnoreCase) >= 0;
                                   
            System.Diagnostics.Debug.WriteLine($"Mostrar tabla bodegas: {mostrarTablaBodegas}");
            System.Diagnostics.Debug.WriteLine($"Tiene datos de bodegas: {Model.TotalesPorBodega?.Any()}");
        }

        @if (mostrarTablaBodegas && Model.TotalesPorBodega != null && Model.TotalesPorBodega.Any())
        {
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header bg-gradient bg-warning py-3">
                        <h5 class="mb-0 text-dark"><i class="fas fa-warehouse me-2"></i>Totales por Bodega</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-scroll">
                            <table id="tabla3" class="table table-hover align-middle mb-0 table-fixed-header">
                                <thead>
                                    <tr class="table-warning-dark">
                                        <th>Bodega</th>
                                        <th class="text-end">Total Kilos</th>
                                        <th class="text-center">Cantidad de Traslados</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (Model.TotalesPorBodega == null || !Model.TotalesPorBodega.Any())
                                    {
                                        <tr>
                                            <td colspan="10" class="text-center">
                                                <div class="alert alert-info mb-0">
                                                    <i class="fas fa-info-circle"></i>
                                                    <span>No hay registros disponibles</span>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                    else
                                    {
                                        @foreach (var item in Model.TotalesPorBodega)
                                        {
                                            <tr>
                                                <td>@item.Bodega</td>
                                                <td class="text-end">@item.TotalKilos.ToString("N2")</td>
                                                <td class="text-center">@item.CantidadMovimientos</td>
                                            </tr>
                                        }
                                    }
                                </tbody>
                                @if (Model.TotalesPorBodega != null && Model.TotalesPorBodega.Any())
                                {
                                    <tfoot>
                                        <tr class="table-warning-dark">
                                            <td>Totales</td>
                                            <td class="text-end">@Model.TotalesPorBodega.Sum(x => x.TotalKilos).ToString("N2")</td>
                                            <td class="text-center">@Model.TotalesPorBodega.Sum(x => x.CantidadMovimientos)</td>
                                        </tr>
                                    </tfoot>
                                }
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        }
            </div>
</div>

@section Scripts {
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="~/js/registroPesajes.js"></script>
    <script>
        $(document).ready(function() {
            initializeServerData(
                '@Context.Request.Query["selectedBarco"]',
                '@Context.Request.Query["empresaId"]'
            );
        });
    </script>
}